<template>
  <div>
    <base-component title="Solutions" icon="mdi-apps" :loading="loading">
      <template #default>
        <div v-if="hasMigrated">
          <v-autocomplete
            v-model="searchText"
            :items="[...apps, ...solutions]"
            :loading="loading"
            color="grey"
            hide-no-data
            hide-selected
            item-text="name"
            placeholder="Search for solutions"
            append-icon="mdi-magnify"
          ></v-autocomplete>
          <h2 class="font-weight-black mx-2">Apps</h2>
          <v-row class="mt-2" align="start" justify="start">
            <v-card
              v-for="app in filteredApps"
              :key="app.topic"
              class="ma-2"
              width="290"
              :loading="loading"
              :disabled="loading"
            >
              <v-img v-if="app.image" class="mt-6" height="100px" :contain="true" :src="app.image"></v-img>
              <v-icon v-else class="ma-4" x-large color="primary">{{app.icon}}</v-icon>
              <v-card-title class="mx-2 font-weight-bold">
                {{app.name}}
                <v-chip
                  v-if="solutionCount[app.type] !== undefined"
                  :loading="true"
                  class="ml-2"
                  small
                  outlined
                >{{solutionCount[app.type]}}</v-chip>
              </v-card-title>
              <v-card-text style="height:100px" class="mx-2 text--primary">
                {{app.description.length > SOLUTION_DESCRIPTION_MAXLENGTH ?
                app.description.slice(0, SOLUTION_DESCRIPTION_MAXLENGTH) + " ..." :
                app.description}}
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn text medium @click.stop="openChatflow(app.topic)">New</v-btn>
                <v-btn text medium @click.stop="viewWorkloads(app.type)">My workloads</v-btn>
              </v-card-actions>
            </v-card>
          </v-row>
          <br />

          <h2 class="font-weight-black mt-4 ml-2">Advanced Solutions</h2>
          <v-row class="mt-2" align="start" justify="start">
            <v-card
              v-for="solution in filteredSolutions"
              :key="solution.topic"
              class="ma-2"
              width="290"
              :loading="loading"
              :disabled="loading"
            >
              <v-img
                v-if="solution.image"
                class="mt-6"
                height="100px"
                :contain="true"
                :src="solution.image"
              ></v-img>
              <v-icon v-else class="ma-4" x-large color="primary">{{solution.icon}}</v-icon>
              <v-card-title class="mx-2 font-weight-bold">
                {{solution.name}}
                <v-chip
                  v-if="solutionCount[solution.type] !== undefined"
                  :loading="true"
                  class="ml-2"
                  small
                  outlined
                >{{solutionCount[solution.type]}}</v-chip>
              </v-card-title>
              <v-card-text style="height:100px" class="mx-2 text--primary">
                {{solution.description.length > SOLUTION_DESCRIPTION_MAXLENGTH ?
                solution.description.slice(0, SOLUTION_DESCRIPTION_MAXLENGTH) + " ..." :
                solution.description}}
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn text medium @click.stop="openChatflow(solution.topic)">New</v-btn>
                <v-btn text medium @click.stop="viewWorkloads(solution.type)">My workloads</v-btn>
              </v-card-actions>
            </v-card>
          </v-row>
          <br />
        </div>

        <v-card v-else class="mx-auto" max-width="344">
          <v-card-text>
            <div>Have to migrate first</div>
            <p class="display-1 text--primary">migrate</p>
            <div class="text--primary">
              The explorer has been upgraded, so you need to initialize the migration of your old reservations to be able to use them.
              <br />To migrate please click on the bellow button.
            </div>
          </v-card-text>
          <v-card-actions>
            <v-btn text color="deep-purple accent-4" @click="migrate">migrate</v-btn>
          </v-card-actions>
        </v-card>
      </template>
    </base-component>
  </div>
</template>
<script>
module.exports = {
  data() {
    return {
      SOLUTION_DESCRIPTION_MAXLENGTH: 130,
      loading: false,
      hasMigrated: true,
      apps: Object.values(APPS),
      solutions: Object.values(SOLUTIONS),
      solutionCount: {},
      searchText: ""
    };
  },
  computed: {
    filteredSolutions() {
      if (this.searchText) {
        return this.solutions.filter(obj => {
          return obj.name === this.searchText;
        });
      } else return this.solutions;
    },
    filteredApps() {
      if (this.searchText) {
        return this.apps.filter(obj => {
          return obj.name === this.searchText;
        });
      } else return this.apps;
    }
  },
  methods: {
    openChatflow(solutionTopic) {
      this.$router.push({
        name: "SolutionChatflow",
        params: { topic: solutionTopic }
      });
    },
    viewWorkloads(solutionType) {
      this.$router.push({ name: "Solution", params: { type: solutionType } });
    },
    getSolutionCount() {
      this.$api.solutions.getCount().then(response => {
        this.solutionCount = JSON.parse(response.data).data;
      });
    },
    migrate() {
      this.$api.solutions.migrate().then(response => {
        window.location.reload();
      });
    }
  },
  mounted() {
    this.getSolutionCount();
  },
  created() {
    this.$api.solutions.hasMigrated().then(response => {
      this.hasMigrated = JSON.parse(response.data).result;
    });
  }
};
</script>
